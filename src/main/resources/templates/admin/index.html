<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	  lang="cs">
	<head>
		<title>Administrace — 24th Lhota Trophy</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="/css/admin.css" type="text/css" />

		<link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
		<link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png" />
		<link rel="manifest" href="favicon/site.webmanifest" />
		<link rel="mask-icon" href="favicon/safari-pinned-tab.svg" color="#5bbad5" />
		<meta name="msapplication-TileColor" content="#da532c" />
		<meta name="theme-color" content="#ffffff" />

		<link rel="stylesheet" href="/css/admin.css" type="text/css" />
		<script src="/vendor/jquery/jquery-3.6.0.min.js" type="text/javascript"></script>
		<script src="/js/main.js" type="text/javascript"></script>
	</head>
	<body class="docu-theme">
		<!--/*
		*	Page Footer
		*/-->
		<header data-noindex="" class="site-header">
			<div class="base-pane">
				<h1>Administrace</h1>
				<p>
					Přihlášený uživatel: <th:block sec:authentication="name"> [ username ] </th:block>
					<th:block sec:authorize="hasAuthority('SUPERADMIN')"> (SUPERADMIN) </th:block>
				</p>
				<form th:action="@{/logout}" method="post"><input type="submit" value="Odhlásit se"/></form>
			</div>
		</header>

		<!--/*
		*	Navigation
		*/-->
		<nav class="breadcrumbs">
			<div class="base-pane">
				<ul>
					<li>Administrace</li>
				</ul>
			</div>
		</nav>

		<!--/*
		*	Page Content
		*/-->
		<main class="page-content">

			<h2>Nastavení plateb</h2>

			<table class="simple-theme" style="min-width: 420px;">
				<tr>
					<th class="center">ID</th>
					<th class="center">Název týmu</th>
					<th class="center">Kontakt</th>
					<th class="center">Částka</th>
					<th class="center">Zaplaceno</th>
				</tr>
				<tr th:each="team : ${teamListing}"
					th:with="
					owner=${team.owner},
					zaplaceno=${owner.getProperty('zaplaceno').orElse(false)}
					"
					th:class="${team.active} ? _ : 'disabled removed'">
					<td class="center"> [[${team.id}]] </td>
					<td> [[${team.name}]] </td>
					<td> [[${owner.email}]] </td>
					<td class="right"> [[${team.expenses}]] Kč</td>
					<td class="right" th:classappend="${!team.active or zaplaceno} ? _ : 'highlight'">
						<span th:id="|paidText-${owner.id}|">[[${zaplaceno ? 'ANO' : 'NE'}]]</span>
						<input th:checked="${zaplaceno} ? 'checked' : _"
							   th:value="${owner.id}"
							   th:disabled="${team.active} ? _ : 'disabled'"
							   name="paidCheckbox" type="checkbox"
							   style="margin-left: 10px;"/>
					</td>
				</tr>
			</table>
		</main>

		<script type="text/javascript">
			/* <![CDATA[ */

			const paidCheckboxes = document.querySelectorAll("input[type=checkbox][name=paidCheckbox]");
			paidCheckboxes.forEach(checkbox => {
				checkbox.addEventListener("change", even => {
					const target = event.target;
					const paid = target.checked === true;
					const userId = target.value;
					LT.log.debug("checked:" + paid + "  val:" + userId);

					const confirmed = window.confirm("Opravdu mám změnit stav platby?");
					if (!confirmed) {
						target.checked = !paid;
						return;
					}

					let onCompleteFn = function (xhr, textStatus) {
						const data = xhr.responseJSON;
						if (textStatus === "success" && data.success === true) {
							const paidTextElement = document.getElementById("paidText-" + userId);
							if (paid) {
								LT.dom.removeClass(target.parentElement, "highlight");
								paidTextElement.innerText = "ANO";
							} else {
								LT.dom.addClass(target.parentElement, "highlight");
								paidTextElement.innerText = "NE";
							}
						} else {
							target.checked = !paid;
							LT.log.error("Nepodariolo nastavit stav platby [" + userId
									+ "]: status " + xhr.status + " / " + textStatus);
							window.alert("Došlo k chbě při ukládání změny stavu platby.");
						}
					};
					
					let requestParams = {
						url: "/rest/admin/setUserProperties/" + userId,
						data: JSON.stringify({zaplaceno: paid}),
						onComplete: onCompleteFn,
						onError: LT.function.noop,
						onTimeout: LT.function.noop,
					};
					LT.ajax.send(requestParams, "paidCheckbox-" + userId);
				});
			});

			/* ]]> */
		</script>

		<!--/*
		*	Page Footer
		*/-->
		<footer data-noindex="" class="site-footer">
			<div class="base-pane center">
				<p th:text="|&copy; 24th Lhota Trophy ${#dates.year(#dates.createNow())}|"> Copyright </p>
			</div>
		</footer>
	</body>
</html>
